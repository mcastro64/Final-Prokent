---
title: "D607 Final Project"
author: "Marco Castro"
date: "2024-11-25"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(httr)
library(purrr)
library(stringr)
library(rvest)
library(textutils)
```

## Overview

```{r init-zips}

zips <- read_csv("zipcodes.csv")
head(zips)
```


This script scrapes the [Zillow] ("https://www.zillow.com/").

```{r init-scraper}




# Read first search 
user_agent <- "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/64.0.3282.140 Safari/537.36 Edge/18.17763"
domain <- "https://www.zillow.com"
city <- "buffalo"
state <- "ny" 
zip <- "14201"
beds <- 0

vars <- ""

uri <- charToRaw(vars)
uri

path <-paste(domain, "/", zip, "/rentals/", sep="") #, city, "-", state, "-"

```

```{r }

set_config(add_headers(`User-Agent` = user_agent))

throttled_GET <- slowly(
  ~read_html(.),
  rate = rate_delay(2)
)

realestate_data <- throttled_GET(path)
# grab html on this page
# realestate_data 

realestate_data

# get the number of jobs per page
result_container <- realestate_data %>% 
  html_element(xpath = '//div[@class="result-list-container"]' )

result_container


# 2. Pages per zip search
# grab the pagination list items
pagination <- result_container %>% 
  html_element(xpath = '//nav[@class="StyledPagination-c11n-8-107-0__sc-4uav85-0 dOdLEd"]') %>% 
  html_elements(xpath = '//li[@class="PaginationNumberItem-c11n-8-107-0__sc-i6f8qs-0 lTbnm"]') %>% 
  html_text() %>%
  strsplit(" ")

# get the total number of search result pages
current_page <- 1
last_page = as.numeric(pagination[length(pagination)]) + 1

listings <- result_container %>% 
  html_element(xpath = 'ul' ) %>%   
  html_elements(xpath = 'li' ) %>%
  html_elements(xpath = '//div//div//article' ) # %>% #//li//article
 # html_text() 

listings_links <- listings 

listings_links

```



This section crawls through each search result page and grabs the unique job listing id. This will be used later to crawl the individual job listing page.




```{r crawl-search-result-pages}

# init the page counter
current_page <- 1

# init the page_ids data frame
page_ids <- data.frame()

# loop though all pages
while (current_page < last_page) {

    # This tells us to go to the next page
    current_page <- current_page + 1
}


```
